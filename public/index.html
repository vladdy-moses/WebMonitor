<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>WebSites.Monitor</title>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" />
	<script type="text/javascript" src="//code.jquery.com/jquery-2.1.1.min.js"></script>
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/datejs/1.0/date.min.js"></script>
	<script type="text/javascript" src="/socket.io/socket.io.js"></script>
	<script type="text/javascript">
		var socket = io();
		$(function() {
			var dangerAlert = $('#dangerAlert');
			
			socket.on('setSites', function(data) {
				var siteTable = $('#siteTable');
				$('#siteTable .siteInfo').remove();
				data.sites.forEach(function(item) {
					siteTable.append(formatSiteItem(item, data.sitesData[item.Id]));
				});
				$('#lastUpdate').text(new Date().toString('dd.MM.yyyy HH:mm:ss'));
			});
			
			socket.on('setSite', function(item) {
				$('#siteTable .site-' + item.site.Id).replaceWith(formatSiteItem(item.site, item.data));
				$('#lastUpdate').text(new Date().toString('dd.MM.yyyy HH:mm:ss'));
			});
			
			socket.on('setSiteInProcess', function(id) {
				$('#siteTable .site-' + id + ' td.id').html('<i class="glyphicon glyphicon-forward"></i>');
			});
			
			socket.on('error', function(data) {
				$('#siteTable tr.siteInfo').remove();
				dangerAlert.show();
				dangerAlert.text('Извините, произошла ошибка при подключении к серверу. Текст ошибки: ' + data.message);
			});
			
			socket.on('connect', function() {
				dangerAlert.hide();
				socket.emit('getSites');
			});
		});
		
		formatSiteItem = function(item, data) {
			var id = item.Id;
			var name = item.Name;
			var uri = '<a href="' + item.Uri + '">' + item.Uri + '</a>';
			var statusText = (typeof(data.lastStatusText) !== 'undefined') ? data.lastStatusText : 'No data';
			var date = (typeof(data.lastStatusDate) !== 'undefined') ? new Date(data.lastStatusDate).toString('dd.MM.yyyy HH:mm:ss') : '-';
			var additionalTrStyle = (data.lastStatus === false) ? ' danger' : '';
			var statusStyle = (typeof(data.lastStatus) !== 'undefined') ? (data.lastStatus ? 'label-success' : 'label-danger') : 'label-default';
			
			return '<tr class="siteInfo site-' + id + additionalTrStyle + '"><td class="id">' + id + '</td><td>' + name + '</td><td>' + uri + '</td><td><span class="label ' + statusStyle + '">' + statusText + '</span></td><td>' + date + '</td></tr>';
		};
	</script>
</head>
<body>
	<div class="container">
		<h3>Статус сайтов</h3>
		<div class="alert alert-danger" role="alert" id="dangerAlert"></div>
		<p>Последнее обновление — <span id="lastUpdate">никогда</span>.</p>
		<table class="table table-striped table-condensed" id="siteTable">
			<tr>
				<th>#</th>
				<th>Имя</th>
				<th>Ссылка</th>
				<th>Статус</th>
				<th>Дата</th>
			</tr>
		</table>
	</div>
</body>
</html>